
@model ge_app.Models.ProcessModel
    
@{
    ViewData["Title"] = "Get MOND Results";
}

    <div class="container">
        <h4>Get MOND Results</h4>
        <form method="get" action="/action_page.php" id="get_list_form">
            <div class="row">  
                <div class="col-sm-6"> 
                    <div class="form-group">
                        <label for="ProjectId">ProjectId
                        <button class="button" type="button" onclick="get_projects()">Load Projects</button>
                        </label>
                        <select class="form-control" type="text" id="qryProjectId" name="qryProjectId"> 
                        
                        </select>

                     </div>
                    <div class="form-group">
                        <label for="PointId">Location (PointId) </label>
                        <button class="button" type="button" onclick="get_points()">Load Points</button>
                    </label>
                    <select class="form-control" type="text" id="qryPointId" name="qryPointId"> 
                    
                    </select>
                    </div>
                    <div class="form-group">
                        <label for="MOND_TYPE">Reading Type (MOND_TYPE)</label>
                        <input class="form-control" type="text" id="qryMOND_TYPE" name="qryMOND_TYPE" placeholder="...enter mond_type">
                    </div>
                </div>
                <div class="col-sm-6"> 
                    <input class="button" type="submit" value="Find">
                </div>
            </div>   
        </form>
            <div class="table-wrapper-scroll-y mond_list-scrollbar">
                <table class="table table-striped" id="mond_table">
                    <thead id="mond_head">
                    </thead>
                <tbody id="mond_body"></tbody>
                </table>
            </div>
           <canvas id="mychart"></canvas>
    </div>  
    
    <script src="~/lib/chart.js/dist/chart.js"></script>  
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
   
    <script type="text/javascript">
    const data = {
        datasets: [{
          label: 'My First dataset',
          backgroundColor: 'rgb(255, 99, 132)',
          borderColor: 'rgb(255, 99, 132)',
          data: [{x: 0, y: 0}]
        }]
      };

      const options = {
        scales: {
          x: {
                title: {
                display: true,
                text: 'Reading DateTime'
                },
                type:'time', 
                time: {
                    unit: 'day',
                    unitStepSize: 7,
                    displayFormats:{
                        'day':'yyyy MMM dd'
                    }
                }
            },
          y: {
            title: {
            display: true,
            text: 'Select MOND_TYPE'
            }
          }
        }
      }

    
      const config = {
        type: 'scatter',
        data: data,
        options: options
      };
    
      var ctx = document.getElementById('mychart').getContext("2d");
      
      const mychart = new Chart(
              ctx,
              config
      );

    function renderChart (data) {

      var chart_select = get_value("chart_select");
      var new_data = []
      
      for (let i = 0; i < data.length; i++) {
            var pt = new Object
            @* pt.x = Date.parse(data[i].DateTime); *@
            pt.x = data[i].DateTime;
            pt.y = parseFloat(data[i].MOND_RDNG);
            new_data.push(pt)
      }
      
      options.scales.y.title.text= data[0].MOND_TYPE + ' ' + data[0].MOND_UNIT;
      
      addData(mychart,new_data,chart_select,0);

    }

    function addData(chart, data, label, datasetIndex) {
      chart.data.datasets[datasetIndex].label = label;
      chart.data.datasets[datasetIndex].data = data;
      chart.update();
    }

    function init_form () {
       
        $("#get_list_form").submit(function(e) {
            e.preventDefault()
            get_mond_results()
        });
    }

    function get_projects() {
        init_form()
        var url = gint_host + '/project';
        httpGetAsync(url,display_projects)
    }
    
    function display_projects(response) {
        var json_data = JSON.parse(response);
        var sel = document.getElementById("qryProjectId");
        sel.innerHTML = ""
        for (var i = 0; i < json_data.length; i++) {
            var project = json_data[i];
            op = document.createElement('option');
            op.setAttribute("value",project.gINTProjectID)
            op.innerHTML = project.PROJ_NAME 
            sel.appendChild(op)
        }

    }

    function get_points() {
        var projectid = get_value("qryProjectId");
        var url = gint_host + '/point/project/' + projectid;

        // test_OktaCORS()

        // if (!OAuth2Client_gINT.token) {
        //    get_token (OAuth2Client_gINT)
        // }
        // httpGetAsync(url,display_points, OAuth2Client_gINT.token)
        
        httpGetAsync(url,display_points)
        
    }
    
    function display_points(response) {
        var json_data = JSON.parse(response);
        var sel = document.getElementById("qryPointId");
        sel.innerHTML = ""
        for (var i = 0; i < json_data.length; i++) {
            var point = json_data[i];
            op = document.createElement('option');
            op.setAttribute("value",point.PointID)
            op.innerHTML = point.PointID 
            sel.appendChild(op)
        }

    }
    function get_mond_results() {
        var projectid = get_value("qryProjectId")
        var pointid = get_value("qryPointId")
        var mond_type = get_value("qryMOND_TYPE")
        var url = gint_host + '/mond/project/' + projectid + '/point/' + pointid + '/type/' + mond_type;
        httpGetAsync(url,display_list)
    }

    function display_list (response) {
        var show_fields = ['PointID','MOND_TYPE','ItemKey','MONG_DIS','DateTime','MOND_RDNG']
        var json_data = JSON.parse(response);
        var thead = document.getElementById("mond_head");
        thead.innerHTML = "";
        tr = document.createElement('tr');
        th = document.createElement('th')
            th.setAttribute("class","d-none")
            th.innerHTML = "GintRecID"
            tr.appendChild(th)
        for (var j = 0; j < show_fields.length; j++) {
            th = document.createElement('th')
            th.innerHTML = show_fields[j]
            tr.appendChild(th)
        }
        thead.appendChild(tr)
        
        var tbody = document.getElementById("mond_body");
        tbody.innerHTML = "";
        for (var i = 0; i < json_data.length; i++) {
        var mond = json_data[i];
        tr = document.createElement('tr');
             td = document.createElement('td')
                td.setAttribute("class","d-none")
                td.innerHTML = mond['GintRecID']
            tr.appendChild(td)
            for (var j = 0; j < show_fields.length; j++) {
                td = document.createElement('td')
                td.innerHTML = mond[show_fields[j]]
            tr.appendChild(td)
            }
            @* td = document.createElement('td')
                btn = document.createElement ('button')
                btn.setAttribute("class", "button")
                btn.setAttribute("onclick", "get_result('" + mond.gINTRecID + "')")
                btn.innerHTML = "Details"
                td.appendChild(btn)
                btn = document.createElement ('button')
                btn.setAttribute("class", "button")
                btn.setAttribute("onclick", "update_mond('" + mond.gINTRecID + "')")
                btn.innerHTML = "Update"
                td.appendChild(btn) 
            tr.appendChild(td)*@
        tbody.appendChild(tr);
        renderChart (json_data)
        } 
    }
    </script>
